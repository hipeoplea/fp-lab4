openapi: 3.1.0
info:
  title: Quiz Backend API
  version: "1.0.0"
  description: >
    REST API for authentication, quiz management and game session creation.
    All JSON timestamps use ISO 8601 UTC format.
servers:
  - url: http://localhost:4000
    description: Local development
tags:
  - name: Auth
    description: Registration and login
  - name: Quizzes
    description: CRUD for quizzes with nested questions and choices
  - name: Games
    description: Create game sessions to run live quizzes
paths:
  /api/auth/register:
    post:
      tags: [Auth]
      summary: Register a new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRegisterRequest'
            example:
              email: user@example.com
              password: secretpassword
              name: Jane Doe
      responses:
        "200":
          description: Registered successfully, JWT issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        "422":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/auth/login:
    post:
      tags: [Auth]
      summary: Log in with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthLoginRequest'
            example:
              email: user@example.com
              password: secretpassword
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "422":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
  /api/quizzes:
    get:
      tags: [Quizzes]
      summary: List quizzes owned by the authenticated user
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Array of quizzes with nested questions and choices
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Quiz'
        "401":
          description: Missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags: [Quizzes]
      summary: Create a quiz with nested questions and choices
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuizCreateRequest'
            example:
              title: Geography basics
              description: Short quiz for classroom
              is_public: false
              questions:
                - type: mcq
                  prompt: Capital of France?
                  time_limit_ms: 20000
                  points: 1000
                  position: 1
                  choices:
                    - text: Paris
                      is_correct: true
                      position: 1
                    - text: Lyon
                      is_correct: false
                      position: 2
      responses:
        "200":
          description: Quiz created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Quiz'
        "401":
          description: Missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "422":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
  /api/quizzes/{id}:
    parameters:
      - $ref: '#/components/parameters/QuizId'
    get:
      tags: [Quizzes]
      summary: Get quiz with nested children by id
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Quiz found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Quiz'
        "401":
          description: Missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "404":
          description: Quiz not found or not owned by the user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags: [Quizzes]
      summary: Replace a quiz and its nested content
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuizCreateRequest'
      responses:
        "200":
          description: Quiz updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Quiz'
        "401":
          description: Missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "404":
          description: Quiz not found or not owned by the user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "422":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
    patch:
      tags: [Quizzes]
      summary: Partially update a quiz
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuizCreateRequest'
      responses:
        "200":
          description: Quiz updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Quiz'
        "401":
          description: Missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "404":
          description: Quiz not found or not owned by the user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "422":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
    delete:
      tags: [Quizzes]
      summary: Delete a quiz
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Quiz removed
        "401":
          description: Missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "404":
          description: Quiz not found or not owned by the user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/games:
    post:
      tags: [Games]
      summary: Create a game session from an existing quiz
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GameSessionCreateRequest'
            example:
              quiz_id: 1
              settings:
                shuffleQuestions: false
      responses:
        "200":
          description: Session created and GameServer started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameSession'
        "401":
          description: Missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "422":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "503":
          description: Could not generate unique PIN after several attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    QuizId:
      name: id
      in: path
      required: true
      schema:
        type: integer
      description: Quiz identifier
  schemas:
    AuthRegisterRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
          description: Unique user email (stored lowercased)
        password:
          type: string
          minLength: 8
          maxLength: 72
          description: Raw password, hashed server-side with Argon2
        name:
          type: string
          nullable: true
          description: Optional display name
    AuthLoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
    AuthResponse:
      type: object
      required: [token, user]
      properties:
        token:
          type: string
          description: JWT signed with HS256, subject claim contains user id
        user:
          $ref: '#/components/schemas/User'
    User:
      type: object
      required: [id, email]
      properties:
        id:
          type: integer
        email:
          type: string
          format: email
        name:
          type: string
          nullable: true
    QuizCreateRequest:
      type: object
      required: [title]
      properties:
        title:
          type: string
          description: Quiz title
        description:
          type: string
          nullable: true
        is_public:
          type: boolean
          default: false
          description: >
            Publication flag. `public` is also accepted as an alias in the payload.
        questions:
          type: array
          description: Ordered list of questions; omitted entries are dropped
          items:
            $ref: '#/components/schemas/QuizQuestionCreateRequest'
    QuizQuestionCreateRequest:
      type: object
      required: [prompt]
      properties:
        type:
          type: string
          enum: [mcq, tf]
          default: mcq
          description: Question type, validated against enum
        prompt:
          type: string
          description: Question text
        time_limit_ms:
          type: integer
          default: 20000
          description: >
            Time limit in milliseconds. If `timer` (seconds) is provided instead,
            it is multiplied by 1000.
        points:
          type: integer
          default: 1000
        position:
          type: integer
          description: >
            1-based order; missing positions are auto-filled using input order.
        choices:
          type: array
          items:
            $ref: '#/components/schemas/QuizChoiceCreateRequest'
          description: Answer choices, kept in provided order
    QuizChoiceCreateRequest:
      type: object
      required: [text]
      properties:
        text:
          type: string
        is_correct:
          type: boolean
          default: false
          description: `correct` is accepted as an alias in the payload
        position:
          type: integer
          description: 1-based order; defaults to array index
    Quiz:
      type: object
      required:
        - id
        - title
        - is_public
        - owner_id
        - created_at
        - updated_at
        - questions
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
          nullable: true
        is_public:
          type: boolean
        owner_id:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        questions:
          type: array
          items:
            $ref: '#/components/schemas/QuizQuestion'
    QuizQuestion:
      type: object
      required:
        - id
        - type
        - prompt
        - time_limit_ms
        - points
        - position
        - quiz_id
        - created_at
        - updated_at
        - choices
      properties:
        id:
          type: integer
        type:
          type: string
          enum: [mcq, tf]
        prompt:
          type: string
        time_limit_ms:
          type: integer
        points:
          type: integer
        position:
          type: integer
        quiz_id:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        choices:
          type: array
          items:
            $ref: '#/components/schemas/QuizChoice'
    QuizChoice:
      type: object
      required:
        - id
        - text
        - is_correct
        - position
        - question_id
        - created_at
        - updated_at
      properties:
        id:
          type: integer
        text:
          type: string
        is_correct:
          type: boolean
        position:
          type: integer
        question_id:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    GameSessionCreateRequest:
      type: object
      required: [quiz_id]
      properties:
        quiz_id:
          type: integer
          description: Identifier of the quiz to play; `quizId` is also accepted
        settings:
          type: object
          nullable: true
          additionalProperties: true
          description: Arbitrary game settings map stored with the session
    GameSession:
      type: object
      required:
        - id
        - quiz_id
        - host_id
        - pin
        - status
        - report_ready
        - state_version
        - created_at
        - updated_at
      properties:
        id:
          type: integer
        quiz_id:
          type: integer
        host_id:
          type: integer
        pin:
          type: string
          description: 6-digit join code
        status:
          type: string
          description: lobby | in_progress | finished
        started_at:
          type: string
          format: date-time
          nullable: true
        ended_at:
          type: string
          format: date-time
          nullable: true
        settings:
          type: object
          additionalProperties: true
        report_ready:
          type: boolean
        state:
          type: object
          nullable: true
          additionalProperties: true
        state_version:
          type: integer
        last_persisted_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Machine-readable error code or message
        details:
          description: Optional error details
    ValidationErrorResponse:
      type: object
      required: [error, details]
      properties:
        error:
          type: string
          const: validation_error
        details:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of field names to validation messages
